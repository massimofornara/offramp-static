<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vendi Token Custom - Zero Blocchi</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    * { box-sizing: border-box; }
    body { margin:0; font-family:'Inter',sans-serif; background:#0f172a; color:#e2e8f0; padding:20px; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { max-width:480px; width:100%; background:#1e293b; border-radius:20px; overflow:hidden; box-shadow:0 20px 50px rgba(0,0,0,0.5); }
    .header { background:linear-gradient(135deg,#8b5cf6,#3b82f6); padding:30px 24px; text-align:center; color:white; }
    .header h1 { margin:0; font-size:26px; }
    .header p { margin:10px 0 0; font-size:14px; opacity:0.9; }
    .body { padding:30px 24px; }
    label { display:block; margin:20px 0 8px; font-size:14px; color:#94a3b8; }
    input, select { width:100%; padding:14px; background:#334155; border:1px solid #475569; color:white; border-radius:12px; font-size:16px; }
    input:focus, select:focus { outline:none; border-color:#8b5cf6; }
    button { width:100%; padding:16px; margin:20px 0; border:none; border-radius:12px; font-size:18px; font-weight:700; cursor:pointer; transition:0.3s; }
    #connectBtn { background:#6366f1; color:white; }
    #connectBtn:hover { background:#4f46e5; }
    #sellBtn { background:#10b981; color:white; }
    #sellBtn:hover:not(:disabled) { background:#059669; }
    #sellBtn:disabled { background:#64748b; cursor:not-allowed; }
    .status, .error, .fallback { padding:12px; border-radius:8px; text-align:center; margin:15px 0; font-size:14px; display:none; }
    .status { background:#064e3b; border:1px solid #10b981; color:#6ee7b7; }
    .error { background:#450a0a; border:1px solid #dc2626; color:#fca5a5; }
    .fallback { background:#1e3a8a; border:1px solid #3b82f6; color:#93c5fd; }
    .note { font-size:13px; color:#94a3b8; text-align:center; line-height:1.6; margin-top:25px; }
  </style>
</head>
<body>

<div class="card">
  <div class="header">
    <h1>Vendi Token Custom al Tuo Prezzo</h1>
    <p>ERC-20/BEP-20 → € su IBAN • Nessun Blocco • No KYC sotto 15k</p>
  </div>

  <div class="body">
    <label>Importo da ricevere</label>
    <input type="number" id="fiatAmount" value="1000" min="10" max="2000" step="1" placeholder="es. 1000" />

    <label>Valuta</label>
    <select id="fiatCurrency">
      <option value="eur">Euro (€) - SEPA</option>
      <option value="usd">Dollaro ($) - ACH</option>
    </select>

    <label>Indirizzo Token (ERC-20/BEP-20)</label>
    <input type="text" id="tokenAddress" value="0xef3f5c1892a8d7a3304e4a15959e124402d69974" />

    <label>Rete</label>
    <select id="network">
      <option value="56">BNB Smart Chain (BSC)</option>
      <option value="42161">Arbitrum One</option>
    </select>

    <button id="connectBtn">Connetti Wallet (MetaMask / Trust)</button>

    <div id="status" class="status">Connesso!</div>
    <div id="error" class="error"></div>
    <div id="fallbackMsg" class="fallback">Provo con Mt Pelerin...</div>

    <button id="sellBtn" disabled>VENDA ORA (Zero Blocchi)</button>

    <p class="note">
      • Token custom supportati • Prezzo deciso da te<br>
      • Mt Pelerin → Guardarian → ChangeNOW (fallback automatico)<br>
      • Funziona sempre • Nessun blocco Cloudflare
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<script>
  let account = null;
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');
  const fallbackMsg = document.getElementById('fallbackMsg');
  const sellBtn = document.getElementById('sellBtn');

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
    setTimeout(() => errorEl.style.display = 'none', 7000);
  }

  function checkReady() {
    const amount = document.getElementById('fiatAmount').value;
    const token = document.getElementById('tokenAddress').value.trim();
    sellBtn.disabled = !account || !amount || amount < 10 || amount > 2000 || !/^0x[a-fA-F0-9]{40}$/.test(token);
  }

  ['fiatAmount', 'tokenAddress', 'network'].forEach(id =>
    document.getElementById(id).addEventListener('input', checkReady)
  );

  // CONNESSIONE WALLET
  document.getElementById('connectBtn').onclick = async () => {
    if (!window.ethereum) return showError("MetaMask non trovato! Installalo.");

    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const web3 = new Web3(window.ethereum);
      const accounts = await web3.eth.getAccounts();
      account = accounts[0].toLowerCase();

      const chainId = document.getElementById('network').value;
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0x' + Number(chainId).toString(16) }],
      });

      statusEl.style.display = 'block';
      statusEl.textContent = `Connesso: \( {account.slice(0,6)}... \){account.slice(-4)}`;
      document.getElementById('connectBtn').style.display = 'none';
      checkReady();
    } catch (err) {
      if (err.code === 4902) {
        showError("Rete non aggiunta. Aggiungila manualmente.");
      } else {
        showError(err.message || "Connessione rifiutata");
      }
    }
  };

  // VENDITA CON 3 FALLBACK AUTOMATICI
  sellBtn.onclick = () => {
    const amount = document.getElementById('fiatAmount').value;
    const fiat = document.getElementById('fiatCurrency').value.toLowerCase();
    const token = document.getElementById('tokenAddress').value.trim().toLowerCase();
    const chainId = document.getElementById('network').value;

    fallbackMsg.style.display = 'block';
    fallbackMsg.textContent = "Apertura Mt Pelerin...";

    const urls = [
      // 1. Mt Pelerin (migliore per custom)
      `https://bridges.mtpelerin.com/?tab=sell&crypto=\( {token}&network= \){chainId}&fiat=\( {fiat}&amount= \){amount}&wallet=${account}&mode=widget&ref=offramp&utm_source=vercel`,
      // 2. Guardarian
      `https://widget.guardarian.com/offramp?sellAsset=\( {token}&chain= \){chainId==='56'?'bsc':'arbitrum'}&fiatCurrency=\( {fiat.toUpperCase()}&fiatAmount= \){amount}&userAddress=${account}`,
      // 3. ChangeNOW
      `https://changenow.io/exchange?from=\( {token}&fromNetwork= \){chainId==='56'?'bsc':'arbitrum'}&to=\( {fiat}&amount= \){amount}&address=${account}&type=offramp`
    ];

    let current = 0;
    const openNext = () => {
      const popup = window.open(urls[current], "offramp", "width=540,height=840,left=200,top=100,noopener,noreferrer");
      
      if (!popup || popup.closed) {
        showError("Popup bloccato! Apri manualmente:");
        alert("Copia questo link:\n\n" + urls[current]);
        return;
      }

      const check = setInterval(() => {
        try {
          if (popup.location.href.includes("mtpelerin") || popup.location.href.includes("guardarian") || popup.location.href.includes("changenow")) {
            clearInterval(check);
            fallbackMsg.textContent = "Connessione riuscita! Completa la vendita.";
          }
        } catch (e) {
          if (current < 2) {
            current++;
            fallbackMsg.textContent = `Provider ${current} bloccato → Provo alternativa...`;
            setTimeout(() => popup.location = urls[current], 1500);
          } else {
            clearInterval(check);
            fallbackMsg.textContent = "Tutte le alternative provate. Usa il link manuale.";
          }
        }
      }, 3000);
    };

    setTimeout(openNext, 600); // Anti-Cloudflare delay
  };

  checkReady();
</script>
</body>
</html>
